{{- $tpl := replace (templates.Current.Name) "_partials/" "" }}
{{- /*
  Create a new Item from a resource file while expanding template code
  Parameters:

  .source:  the path of the source template relative to the assets/templates folder
  .target:  the target path relative to the current page. (logical path)
            if not specified $source will be used using the same folder structure from assets
  .base:    if set the lookup folder is changed to assets/$base
  .page:    The Page object for which this is rendered.
  .params:  parameters that can be accessed in the template code
            the actual parameters passed is a merge of
              - .page.params
              - .page.Params
              - site parameters may be accessed using the global site function

*/ -}}
{{- if not $.page }}
  {{- errorf "%-25s: missing 'page' parameter" $tpl }}
{{- end }}
{{- if not $.source }}
  {{- errorf "%-25s: missing 'source' parameter" $tpl }}
{{- end }}

{{- $page := .page }}
{{- $pagePath := $page.Path }}
{{- $base := or .base "templates" }}
{{- $source := add $base "/" .source }}
{{- /* calculate relative target path from current page */ -}}
{{- $target := add $page.Path "/" (or $.target $.source) }}
{{- $target = $target | replaceRE `^/grammars` "" }}

{{- /* merge page parameters with additional arguments passed */ -}}
{{- $params := (dict "page" $page "site" site) }}
{{- with $.params }}
  {{- $params = merge $params . }}
{{- end }}

{{- with resources.Get $source }}
  {{- with resources.FromString $target .Content }}
    {{- with $gen := resources.ExecuteAsTemplate $target $params . }}
      {{- if .Content | findRE `(?s)<no value>` }}
        {{- warnf "WARN %-25s[ %-20s ]: unreplaced parameter: '%s' -> '%s'" $tpl $pagePath $source $target }}
        {{- warnf "WARN ----\n%s\nWARN ----" (debug.Dump $params) }}
      {{- end }}
      {{- .Publish }}
      {{- warnf "OK   %-25s[ %-20s ]: published '%s' -> '%s'" $tpl $pagePath $source $target}}
    {{- else }}
      {{- errorf "FAIL %-25s[ %-20s ]: ExecuteAsTemplate failed for '%s'" $tpl $pagePath $source }}
    {{- end }}
  {{- else }}
    {{- errorf "FAIL %-25s[ %-20s ]: FromString failed for '%s'" $tpl $pagePath $source }}
  {{- end }}
{{- else }}
  {{- errorf "FAIL %-25s[ %-20s ]: missing source at '/%s/%s'" $tpl $pagePath $base $source }}
{{- end }}
{{- /* remove all trailing whitespace */ -}}