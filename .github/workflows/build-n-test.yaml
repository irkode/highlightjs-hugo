# This is prepared for builing on windows and linux either as matrix or single run
# as of now the ONLY_EXTRA is not considered on linux runner
# It looks like the `npm run test-markup` on linux is not properly enumerating the extra modules
# dunno if this is node/npm problem or the implementation of the Highlight.js build scripts or mine
name: Build and Test

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      # Versions are loaded from '.versions after checkout' and pushed to $ENV
      # GO_VERSION:
      # HUGO_VERSION:
      # NODE_VERSION:
      # HIGHLIGHTJS_VERSION:
      ONLY_EXTRA: true
      WORK_DIR: ${{ github.workspace }}/work
      HIGHLIGHTJS_DIR: ${{ github.workspace }}/work/highlight.js
      HIGHLIGHTJS_EXTRA_DIR: ${{ github.workspace }}/work/highlight.js/extra
      DISTRIBUTION_DIR: ${{ github.workspace }}/dist

    steps:
      - name: Checkout highlightjs-hugo repository
        uses: actions/checkout@v6
        with:
          ref: main
          submodules: "true"
          fetch-depth: 0
          # token: ${{ secrets.PUBLISH_TOKEN }}

      - name: Set Tool Versions
        run: |
          ./build/versions-set-wanted.ps1 -Verbose .versions.json

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: .node.package.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "${{ env.GO_VERSION }}"
          cache: true

      - name: Cache Hugo binary
        id: cache-hugo
        uses: actions/cache/restore@v5
        with:
          path: ${{ github.workspace }}/work/bin
          key: hugo-${{ runner.os }}-${{ env.HUGO_VERSION }}

      - name: Download Hugo if not cached (Windows)
        if: steps.cache-hugo.outputs.cache-hit != 'true'
        run: |
          $url = "https://github.com/gohugoio/hugo/releases/download/v${env:HUGO_VERSION}/hugo_extended_${env:HUGO_VERSION}_windows-amd64.zip"
          Write-Host "Downloading Hugo from $url to ${{ github.workspace }}/work/bin"
          [void](New-Item -ItemType Directory -Force -Path ${{ github.workspace }}/work/bin)
          $archiveName = "hugo.zip"
          Invoke-WebRequest -Uri $url -OutFile $archiveName
          Expand-Archive -Path $archiveName -DestinationPath ${{ github.workspace }}/work/bin -Force
          Remove-Item $archiveName

      - name: Save Hugo Cache
        if: steps.cache-hugo.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: ${{ github.workspace }}/work/bin
          key: hugo-${{ runner.os }}-${{ env.HUGO_VERSION }}

      - name: Add Hugo to Path
        run: |
          "${{ github.workspace }}/work/bin/" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Check Versions
        run: |
          ./build/versions-check-installed.ps1 -Verbose -VersionConfigFile .versions.json

      # SETUP Highlight.js (clone, npm ci - cache - save folder path)
      - name: Cache Highlight.js clone and dependencies
        id: cache-highlightjs
        uses: actions/cache/restore@v5
        with:
          path: ${{ env.HIGHLIGHTJS_DIR }}
          key: highlightjs-${{ runner.os }}-${{ env.HIGHLIGHTJS_VERSION }}

      - name: Clone and Setup Highlight.js
        if: steps.cache-highlightjs.outputs.cache-hit != 'true'
        run: |
          git clone --branch ${{ env.HIGHLIGHTJS_VERSION }} --depth 1 https://github.com/highlightjs/highlight.js.git "${{ env.HIGHLIGHTJS_DIR }}"
          cd "${{ env.HIGHLIGHTJS_DIR }}"
          npm ci
          npm audit fix
          Write-Host "Highlight.js version folder ready at: ${env:HIGHLIGHTJS_DIR}"

      - name: Cache Highlight.js clone and dependencies
        if: steps.cache-highlightjs.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: ${{ env.HIGHLIGHTJS_DIR }}
          key: highlightjs-${{ runner.os }}-${{ env.HIGHLIGHTJS_VERSION }}

      - name: Generate Custom Modules
        working-directory: ./build/hugen
        run: |
          & hugo.exe -d ${{ env.HIGHLIGHTJS_EXTRA_DIR }}

      - name: Build Highlight.js incl. custom modules and CDNs
        working-directory: ${{ env.HIGHLIGHTJS_DIR }}
        run: |
          npm run build
          npm run test-markup
          node ./tools/build.js hugo-html hugo-text -t cdn

      - name: Build Discourse plugin
        run: |
          $PluginSourceFolder = "${{ env.HIGHLIGHTJS_EXTRA_DIR }}/hugo-text/dist"
          $PluginTargetFolder = "${{ env.HIGHLIGHTJS_EXTRA_DIR }}/plugins/discourse"
          ./build/build-discourse-plugin.ps1 -Verbose $PluginSourceFolder $PluginTargetFolder -ErrorAction Stop

      - name: Build Highlight.js plugin
        run: |
          $PluginSourceFolder = "${{ env.HIGHLIGHTJS_EXTRA_DIR }}/hugo-html/dist"
          $PluginTargetFolder = "${{ env.HIGHLIGHTJS_EXTRA_DIR }}/plugins/highlightjs"
          ./build/build-highlightjs-plugin.ps1 -Verbose $PluginSourceFolder $PluginTargetFolder -ErrorAction Stop

      - name: Publish to distribution folder
        run: |
          Remove-Item -Recurse -Force ${{ env.DISTRIBUTION_DIR }}/*
          Get-ChildItem -Directory ${{ env.HIGHLIGHTJS_EXTRA_DIR }} | Copy-Item -Recurse -Destination ${{ env.DISTRIBUTION_DIR }}
          "==== STATUS ===================" | Out-Host
          git status dist

      - name: Publish build results
        working-directory: ${{ env.DISTRIBUTION_DIR }}
        run: |
          $sha = ${env:GITHUB_SHA}
          $shortSha = $sha.Substring(0,7)
          "COMMIT ID: $shortSha" | Out-Host
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          "==== DIST_DIR ===================" | Out-Host
          "==== $(Get-Location)" | Out-Host
          "------------------------------------" | Out-Host
          git status .
          "==== RELEASE_DIR ===================" | Out-Host
          $changed = $false
          git diff --quiet .
          $changed = $LASTEXITCODE -ne 0
          if (-Not $changed) {
            git diff --cached --quiet .
            $changed = $LASTEXITCODE -ne 0
          }
          if (-Not $changed) {
            $changed = (git ls-files --others --exclude-standard).Count -ne 0
          }
          if ($changed) {
            $message = "ci(build): Update dist folder based on [$shortSha]"
            Write-Host $message
            git add .
            git commit -m $message
            git push origin main
          } else {
            Write-Host "No distribution file change: Nothing to commit"
          }
